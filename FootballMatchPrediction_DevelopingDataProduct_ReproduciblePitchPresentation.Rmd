---
title: "Football Match Result Prediction using Machine Learning models"
subtitle: "Reproducible Pitch Presentation - Developing Data Products - Final Assignment"
author: "Sebastian Gomez"
date: "7/04/2021"
output: 
        ioslides_presentation:
                keep_md: yes
---

```{r setup, include=FALSE}
library(shiny)
library(caret)
library(parallel)
library(doParallel)
library(caretEnsemble)
library(ranger)
library(e1071)
library(kernlab)
library(ggplot2)
cluster <- makeCluster(detectCores() - 1) # convention to leave 1 core for OS
registerDoParallel(cluster)
```


<style type="text/css">
body, td {
   font-size: 8px;
}
code.r{
  font-size: 13px;
}
pre {
  font-size: 13px
}
</style>

## Summary

This presentation describes the process of developing several ML models to predict 
the result (HOME WINS/DRAW/AWAY WINS) of football matches using the odds published by 2
of the most famous betting sites: Bet 365 and Blue Square. Below is the code to 
decompress and preprocess the data used to train the different models, which was downloaded from:
https://www.kaggle.com/caesarlupum/betsstrategy


```{r warning = FALSE}
unzip('europeansoccerdatabase.zip')
football = read.csv('FootballDataEurope.csv')
football = football[complete.cases(football[, c('country_name', 'league_name', 'home_team', 
        'away_team','B365H', 'B365D', 'B365A', 'BSH', 'BSD', 'BSA', 'diff_goals')]),]
football$result = football$diff_goals
football$result[football$result > 0] = 'home wins'
football$result[football$result < 0] = 'away wins'
football$result[football$result == 0] = 'draw'
football$result = as.factor(football$result)
football$diff_goals = as.factor(football$diff_goals)
```

## Training and testing data partitioning

The below code was used to partition the downloaded data set into training and testing sets of
0.6 and 0.4 complete observations respectively:

```{r warning = FALSE, results = FALSE}
set.seed(100)
modTrainingPartition = createDataPartition(y = football$diff_goals, p = 0.6, list = FALSE)
fbmodeltraining = football[modTrainingPartition, ]
fbmodeltesting = football[-modTrainingPartition, ]
data = fbmodeltraining[, !names(fbmodeltraining) %in% c('diff_goals', 'country_name',
                        'league_name', 'home_team', 'away_team')]
football = football[, c('country_name', 'league_name', 'home_team', 'away_team','B365H', 
                        'B365D', 'B365A', 'BSH', 'BSD', 'BSA', 'diff_goals')]
fitControl <- trainControl(method = "repeatedcv", number = 5, repeats = 3, 
        allowParallel = TRUE)
```

## Prediction models

The following 7 prediction models were built using the caret package (code is not being evaluated as it is tremendously time consuming, but it can be used for reproducibility purposes):

```{r warning = FALSE, results = FALSE, eval = FALSE}
fitTreeResult = train(result ~ ., data = data, method = 'rpart', trControl = fitControl)
fitRFResult = train(result ~ ., data = data, method = 'rf', trControl = fitControl)
fitNNResult = train(result ~ ., data = data, method = 'nnet', trControl = fitControl)
fitLDAResult = train(result ~ ., data = data, method = 'lda', trControl = fitControl)
fitRangeresult = train(result ~ ., data = data, method = 'ranger', trControl = fitControl)
fitKNNResult = train(result ~ ., data = data, method = 'knn', trControl = fitControl)
fitSVMRadialesult = train(result ~ ., data = data, method = 'svmRadial', trControl = fitControl)
```

```{r warning = FALSE, include = FALSE}
fitTreeResult <- readRDS(file = 'ShinyAppFinalAssignment/EuropeanFootballResultPredictionModel_FinalAssignment/fitTreeResult.rds',.GlobalEnv)
fitRFResult <- readRDS(file = 'ShinyAppFinalAssignment/EuropeanFootballResultPredictionModel_FinalAssignment/fitRFResult.rds',.GlobalEnv)
fitNNResult <- readRDS(file = 'ShinyAppFinalAssignment/EuropeanFootballResultPredictionModel_FinalAssignment/fitNNResult.rds',.GlobalEnv)
fitLDAResult <- readRDS(file = 'ShinyAppFinalAssignment/EuropeanFootballResultPredictionModel_FinalAssignment/fitLDAResult.rds',.GlobalEnv)
fitRangeresult <- readRDS(file = 'ShinyAppFinalAssignment/EuropeanFootballResultPredictionModel_FinalAssignment/fitRangeresult.rds',.GlobalEnv)
fitKNNResult <- readRDS(file = 'ShinyAppFinalAssignment/EuropeanFootballResultPredictionModel_FinalAssignment/fitKNNResult.rds',.GlobalEnv)
fitSVMRadialesult <- readRDS(file = 'ShinyAppFinalAssignment/EuropeanFootballResultPredictionModel_FinalAssignment/fitSVMRadialesult.rds',.GlobalEnv)
fitRFStackedResult <- readRDS(file = 'ShinyAppFinalAssignment/EuropeanFootballResultPredictionModel_FinalAssignment/fitRFStackedResult.rds',.GlobalEnv)

predTrainTreeResult = predict(fitTreeResult, newdata = fbmodeltraining, na.action = na.exclude)
predTrainRFResult = predict(fitRFResult, newdata = fbmodeltraining, na.action = na.exclude)
predTrainNNResult = predict(fitNNResult, newdata = fbmodeltraining, na.action = na.exclude)
predTrainLDAResult = predict(fitLDAResult, newdata = fbmodeltraining, na.action = na.exclude)
predTrainRangerResult = predict(fitRangeresult, newdata = fbmodeltraining, na.action = na.exclude)
predTrainKNNResult = predict(fitKNNResult, newdata = fbmodeltraining, na.action = na.exclude)
predTrainSVMRadialResult = predict(fitSVMRadialesult, newdata = fbmodeltraining, na.action = na.exclude)
stackedTrainingPredictions = data.frame(matrix(NA, nrow = length(fbmodeltraining$result), ncol = 0))
stackedTrainingPredictions$result = fbmodeltraining$result
stackedTrainingPredictions$predTreeResult = predTrainTreeResult
stackedTrainingPredictions$predRFResult = predTrainRFResult
stackedTrainingPredictions$predNNResult = predTrainNNResult
stackedTrainingPredictions$predLDAResult = predTrainLDAResult
stackedTrainingPredictions$predRangerResult = predTrainRangerResult
stackedTrainingPredictions$predKNNResult = predTrainKNNResult
stackedTrainingPredictions$predSVMRadialResult = predTrainSVMRadialResult
```

And, with their respective predictions, a stacked random forest model was also developed:

```{r warning = FALSE, results = FALSE, eval = FALSE}
fitRFStackedResult = train(result ~ ., data = stackedTrainingPredictions, method = 'rf', trControl = fitControl)
```

## Accuracy Results

```{r warning = FALSE, include = FALSE}
predTrainRFStackedResult = predict(fitRFStackedResult, newdata = stackedTrainingPredictions, na.action = na.exclude)
stopCluster(cluster)
registerDoSEQ()
metrics = data.frame()
confTrainTreeResult = confusionMatrix(predTrainTreeResult, fbmodeltraining$result)
metrics = rbind(metrics, c('Result', 'Training','RPart Tree',confTrainTreeResult$overall))
names(metrics) = c('Predicted Variable', 'Data Source', 'Model', names(confTrainTreeResult$overall))
confTrainRFResult = confusionMatrix(predTrainRFResult, fbmodeltraining$result)
metrics = rbind(metrics, c('Result', 'Training', 'Random Forests', confTrainRFResult$overall))
confTrainNNResult = confusionMatrix(predTrainNNResult, fbmodeltraining$result)
metrics = rbind(metrics, c('Result', 'Training', 'Neural Networks', confTrainNNResult$overall))
confTrainLDAResult = confusionMatrix(predTrainLDAResult, fbmodeltraining$result)
metrics = rbind(metrics, c('Result', 'Training', 'LDA', confTrainLDAResult$overall))
confTrainRangerResult = confusionMatrix(predTrainRangerResult, fbmodeltraining$result)
metrics = rbind(metrics, c('Result', 'Training', 'Ranger', confTrainRangerResult$overall))
confTrainKNNResult = confusionMatrix(predTrainKNNResult, fbmodeltraining$result)
metrics = rbind(metrics, c('Result', 'Training', 'KNN', confTrainKNNResult$overall))
confTrainSVMRadialResult = confusionMatrix(predTrainSVMRadialResult, fbmodeltraining$result)
metrics = rbind(metrics, c('Result', 'Training', 'SVM Radial', confTrainSVMRadialResult$overall))
confTrainRFStackedResult = confusionMatrix(predTrainRFStackedResult, fbmodeltraining$result)
metrics = rbind(metrics, c('Result', 'Training', 'Stacked Random Forest', confTrainRFStackedResult$overall))
predTestTreeResult = predict(fitTreeResult, newdata = fbmodeltesting, na.action = na.exclude)
predTestRFResult = predict(fitRFResult, newdata = fbmodeltesting, na.action = na.exclude)
predTestNNResult = predict(fitNNResult, newdata = fbmodeltesting, na.action = na.exclude)
predTestLDAResult = predict(fitLDAResult, newdata = fbmodeltesting, na.action = na.exclude)
predTestRangerResult = predict(fitRangeresult, newdata = fbmodeltesting, na.action = na.exclude)
predTestKNNResult = predict(fitKNNResult, newdata = fbmodeltesting, na.action = na.exclude)
predTestSVMRadialResult = predict(fitSVMRadialesult, newdata = fbmodeltesting, na.action = na.exclude)
stackedTestingPredictions = data.frame(matrix(NA, nrow = length(fbmodeltesting$result), ncol = 0))
stackedTestingPredictions$result = fbmodeltesting$result
stackedTestingPredictions$predTreeResult = predTestTreeResult
stackedTestingPredictions$predRFResult = predTestRFResult
stackedTestingPredictions$predNNResult = predTestNNResult
stackedTestingPredictions$predLDAResult = predTestLDAResult
stackedTestingPredictions$predRangerResult = predTestRangerResult
stackedTestingPredictions$predKNNResult = predTestKNNResult
stackedTestingPredictions$predSVMRadialResult = predTestSVMRadialResult
predTestRFStackedResult = predict(fitRFStackedResult, newdata = stackedTestingPredictions, na.action = na.exclude)
confTestTreeResult = confusionMatrix(predTestTreeResult, fbmodeltesting$result)
metrics = rbind(metrics, c('Result', 'Testing', 'RPart Tree', confTestTreeResult$overall))
confTestRFResult = confusionMatrix(predTestRFResult, fbmodeltesting$result)
metrics = rbind(metrics, c('Result', 'Testing', 'Random Forests', confTestRFResult$overall))
confTestNNResult = confusionMatrix(predTestNNResult, fbmodeltesting$result)
metrics = rbind(metrics, c('Result', 'Testing', 'Neural Networks', confTestNNResult$overall))
confTestLDAResult = confusionMatrix(predTestLDAResult, fbmodeltesting$result)
metrics = rbind(metrics, c('Result', 'Testing', 'LDA', confTestLDAResult$overall))
confTestRangerResult = confusionMatrix(predTestRangerResult, fbmodeltesting$result)
metrics = rbind(metrics, c('Result', 'Testing', 'Ranger', confTestRangerResult$overall))
confTestKNNResult = confusionMatrix(predTestKNNResult, fbmodeltesting$result)
metrics = rbind(metrics, c('Result', 'Testing', 'KNN', confTestKNNResult$overall))
confTestSVMRadialResult = confusionMatrix(predTestSVMRadialResult, fbmodeltesting$result)
metrics = rbind(metrics, c('Result', 'Testing', 'SVM Radial', confTestSVMRadialResult$overall))
confTestRFStackedResult = confusionMatrix(predTestRFStackedResult, fbmodeltesting$result)
metrics = rbind(metrics, c('Result', 'Testing', 'Stacked Random Forest', confTestRFStackedResult$overall))
```

For additional information regarding the code, please refer to 
code files in https://github.com/sgomezgomez/DevelopingDataProducts_FinalAssignment.

```{r warning = FALSE, fig.height = 3.5, echo = FALSE}
metrics$Model = as.factor(metrics$Model)
metrics$`Data Source` = as.factor(metrics$`Data Source`)
g <- ggplot(metrics, aes(x = Model, Accuracy, fill = `Data Source`))
g + geom_col(position = "dodge") +
        ggtitle("Model Accuracy per training and testing data sets") +
        labs(caption = 'Caption: Plots the accuracy from all prediction  models against the training and testing sets. 
             It is important to mention that accuracy values against the testing set were not good, 
             and further work will be required to improve predictions.') +
        xlab('Prediction model') +
        ylab('Accurary') +
        theme(plot.title = element_text(hjust = 0.5, size = 16)) +
        theme(axis.text.x = element_text(size = 6, angle = 45, hjust = .5, vjust = .5, face = "plain"))
```

